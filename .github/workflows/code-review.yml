name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize] # ç•¶ PR è¢«é–‹å•Ÿæˆ–æ›´æ–°æ™‚è§¸ç™¼
    branches:
      - main # åªé‡å°æŒ‡å‘ main åˆ†æ”¯çš„ PR

permissions:
  contents: read
  pull-requests: write # è³¦äºˆå¯«å…¥ PR ç•™è¨€çš„æ¬Šé™

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ç²å–æ‰€æœ‰ git æ­·å²ï¼Œä»¥ä¾¿æ¯”è¼ƒåˆ†æ”¯

      - name: Get PR Diff
        id: get_diff
        run: |
          # å–å¾— Pull Request çš„ base å’Œ head commit SHA
          BASE_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" ${{ github.event.pull_request.url }} | jq -r .base.sha)
          HEAD_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" ${{ github.event.pull_request.url }} | jq -r .head.sha)
          
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"

          # ç”¢ç”Ÿ diff ä¸¦å„²å­˜åˆ°è¼¸å‡ºè®Šæ•¸
          DIFF=$(git diff $BASE_SHA $HEAD_SHA)
          if [ -z "$DIFF" ]; then
            echo "No changes detected."
            echo "diff_content=No changes to review." >> $GITHUB_OUTPUT
          else
            # å°‡ diff å…§å®¹è½‰æ›ç‚ºé©åˆ JSON çš„æ ¼å¼
            DIFF=$(echo "$DIFF" | jq -Rs .)
            echo "diff_content=$DIFF" >> $GITHUB_OUTPUT
          fi

      - name: Call Gemini API for Code Review
        id: gemini_review
        if: steps.get_diff.outputs.diff_content != 'No changes to review.' # å¦‚æœæœ‰è®Šæ›´æ‰åŸ·è¡Œ
        run: |
          PROMPT="Please act as a senior software engineer. Review the following code changes (git diff format) and provide constructive feedback. Focus on code quality, potential bugs, style consistency, and best practices. If there are no major issues, confirm that the code looks good. Here is the diff:\n\n${{ steps.get_diff.outputs.diff_content }}"

          # å»ºç«‹ JSON payload
          JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" \
            '{ "contents": [ { "parts": [ { "text": $prompt } ] } ] }')

          # å‘¼å« Gemini API
          API_RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
          
          # æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
          if echo "$API_RESPONSE" | jq -e '.error' > /dev/null; then
            echo "Error from Gemini API:"
            echo "$API_RESPONSE"
            REVIEW_COMMENT="Error processing code review by Gemini."
          else
            # è§£æå›æ‡‰ä¸¦æå– review å…§å®¹
            REVIEW_COMMENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          fi

          # å°‡ review ç•™è¨€å„²å­˜åˆ° GitHub çš„è¼¸å‡ºè®Šæ•¸ä¸­ï¼Œä»¥ä¾¿å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment to PR
        if: steps.gemini_review.outputs.review_comment != '' # å¦‚æœæœ‰ review å…§å®¹æ‰ç•™è¨€
        uses: actions/github-script@v7
        with:
          script: |
            const review_body = `### ğŸ¤– Gemini AI Code Review\n\n${{ steps.gemini_review.outputs.review_comment }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review_body
            });
