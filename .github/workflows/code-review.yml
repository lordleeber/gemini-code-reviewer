name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: get_diff
        run: |
          set -eo pipefail
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          DIFF_CONTENT=$(git diff $BASE_SHA $HEAD_SHA)

          if [ -z "$DIFF_CONTENT" ]; then
            echo "diff_content=null" >> $GITHUB_OUTPUT
          else
            echo 'diff_content<<EOF' >> $GITHUB_OUTPUT
            echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
          fi

      - name: Run AI Code Review Script
        id: gemini_review
        if: steps.get_diff.outputs.diff_content != 'null'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_DIFF: ${{ steps.get_diff.outputs.diff_content }}
        run: |
          set -eo pipefail
          pip install requests
          python .github/scripts/review.py

      # ================== å·²ä¿®æ­£çš„åµéŒ¯æ­¥é©Ÿ ==================
      - name: Debug Outputs
        if: always() # ç„¡è«–å¦‚ä½•éƒ½åŸ·è¡Œæ­¤æ­¥é©Ÿ
        run: |
          echo "--- åµéŒ¯è³‡è¨Š ---"
          echo ""
          echo "1. 'get_diff' æ­¥é©Ÿçš„è¼¸å‡ºæ˜¯å¦ç‚º 'null' å­—ä¸²ï¼Ÿ"
          IS_NULL=${{ steps.get_diff.outputs.diff_content == 'null' }}
          echo "çµæœ: $IS_NULL"
          echo ""
          echo "---"
          echo ""
          echo "2. 'gemini_review' æ­¥é©Ÿçš„è¼¸å‡º (stdout):"
          echo "--- START OF STDOUT ---"
          echo "${{ steps.gemini_review.outputs.stdout }}"
          echo "--- END OF STDOUT ---"
          echo ""
          STDOUT_LENGTH=$(echo -n "${{ steps.gemini_review.outputs.stdout }}" | wc -c)
          echo "3. 'gemini_review' è¼¸å‡ºçš„å­—å…ƒé•·åº¦: $STDOUT_LENGTH"
          echo ""
          echo "--- åµéŒ¯è³‡è¨ŠçµæŸ ---"
      # ======================================================

      - name: Post Review Comment to PR
        if: steps.gemini_review.outputs.stdout != ''
        uses: actions/github-script@v7
        with:
          script: |
            const review_body = `### ğŸ¤– Gemini AI Code Review\n\n${{ steps.gemini_review.outputs.stdout }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review_body
            });