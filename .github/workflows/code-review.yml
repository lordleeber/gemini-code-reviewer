name: Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: get_diff
        run: |
          set -eo pipefail # å¦‚æœä»»ä½•æŒ‡ä»¤å¤±æ•—ï¼Œç«‹å³çµ‚æ­¢

          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "Comparing commits: $BASE_SHA...$HEAD_SHA"

          DIFF_CONTENT=$(git diff $BASE_SHA $HEAD_SHA)

          if [ -z "$DIFF_CONTENT" ]; then
            echo "No changes detected."
            echo "diff_json=null" >> $GITHUB_OUTPUT
          else
            echo "diff_json=$(echo "$DIFF_CONTENT" | jq -Rs .)" >> $GITHUB_OUTPUT
          fi

      - name: Call Gemini API for Code Review
        id: gemini_review
        if: steps.get_diff.outputs.diff_json != 'null'
        run: |
          set -eo pipefail
          
          # 1. ä½¿ç”¨ heredoc å°‡ prompt æ¨¡æ¿å®‰å…¨åœ°å­˜å…¥ä¸€å€‹è®Šæ•¸
          # é€™ç¨®æ–¹æ³•å°æ–¼å¤šè¡Œæ–‡å­—å’Œç‰¹æ®Šå­—å…ƒéå¸¸å®‰å…¨
          PROMPT_TEMPLATE=$(cat <<'EOF'
          Please act as a senior software engineer. Review the following code changes (git diff format) and provide constructive feedback. Focus on code quality, potential bugs, style consistency, and best practices. If there are no major issues, confirm that the code looks good. Here is the diff:
          
          EOF
          )
          
          # 2. å¾ä¸Šä¸€æ­¥çš„è¼¸å‡ºä¸­ç²å– JSON æ ¼å¼çš„ diff å…§å®¹
          DIFF_CONTENT_JSON=${{ steps.get_diff.outputs.diff_json }}
          
          # 3. ä½¿ç”¨ --arg å’Œ --argjson å°‡æ¨¡æ¿å’Œ diff ä½œç‚ºåƒæ•¸å‚³éçµ¦ jq
          #    --arg:      å°‡å¾ŒçºŒå…§å®¹è¦–ç‚ºæ™®é€šå­—ä¸²
          #    --argjson:  å°‡å¾ŒçºŒå…§å®¹è¦–ç‚ºå·²æ ¼å¼åŒ–å¥½çš„ JSON
          # é€™æ¨£ jq ç¨‹å¼ç¢¼æœ¬èº«å°±éå¸¸ä¹¾æ·¨ï¼Œåªè² è²¬æ‹¼æ¥è®Šæ•¸
          JSON_PAYLOAD=$(jq -n \
            --arg template "$PROMPT_TEMPLATE" \
            --argjson diff "$DIFF_CONTENT_JSON" \
            '{
              "contents": [
                {
                  "parts": [
                    {
                      "text": ($template + $diff)
                    }
                  ]
                }
              ]
            }')
          
          # 4. å‘¼å« Gemini API (èˆ‡ä¹‹å‰ç›¸åŒ)
          API_RESPONSE=$(curl --fail -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
          
          # 5. è§£æå›æ‡‰ (èˆ‡ä¹‹å‰ç›¸åŒ)
          REVIEW_COMMENT=$(echo "$API_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not parse Gemini response."')
          
          # 6. å„²å­˜è¼¸å‡º (èˆ‡ä¹‹å‰ç›¸åŒ)
          echo "review_comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment to PR
        if: steps.gemini_review.outputs.review_comment != ''
        uses: actions/github-script@v7
        with:
          script: |
            const review_body = `### ğŸ¤– Gemini AI Code Review\n\n${{ steps.gemini_review.outputs.review_comment }}`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review_body
            });